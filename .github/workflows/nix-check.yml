name: Nix Check

on:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  # Linting and formatting check (runs first and fast)
  lint-format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Run pre-commit checks
        run: nix build .#checks.x86_64-linux.pre-commit --print-build-logs

  # Flake metadata check
  flake-info:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Show flake metadata
        run: nix flake metadata

      - name: Show flake outputs
        run: nix flake show

  # Check custom packages
  packages:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: [dfx, haystack-editor]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nix-community
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Build package ${{ matrix.package }}
        run: nix build .#${{ matrix.package }} --print-build-logs

  # Check NixOS configuration
  nixos-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nix-community
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Evaluate NixOS configuration
        run: |
          nix eval .#nixosConfigurations.nixos.config.system.build.toplevel.outPath

      - name: Check NixOS configuration syntax
        run: |
          nix build .#nixosConfigurations.nixos.config.system.build.toplevel --dry-run

  # Check Home Manager configurations
  home-manager-configs:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        host: [nixos, wsl]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nix-community
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Evaluate Home Manager config for ${{ matrix.host }}
        run: |
          nix eval .#homeConfigurations.\"t4d4@${{ matrix.host }}\".config.home.username

      - name: Build Home Manager configuration for ${{ matrix.host }}
        run: |
          nix build .#homeConfigurations.\"t4d4@${{ matrix.host }}\".activationPackage --print-build-logs

  # Check individual modules
  module-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module-type: [common, linux]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Check ${{ matrix.module-type }} modules syntax
        run: |
          for module in modules/home/${{ matrix.module-type }}/*.nix; do
            echo "Checking $module"
            nix-instantiate --parse "$module" > /dev/null
          done

  # Full flake check (comprehensive but slower)
  full-check:
    runs-on: ubuntu-latest
    needs: [flake-info, packages, nixos-config, home-manager-configs, module-check]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            extra-substituters = https://nix-community.cachix.org
            extra-trusted-public-keys = nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nix-community
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Run full flake check
        run: nix flake check --print-build-logs
        continue-on-error: true

  # Summary
  summary:
    runs-on: ubuntu-latest
    needs: [lint-format, flake-info, packages, nixos-config, home-manager-configs, module-check]
    if: always()
    steps:
      - name: Check status
        run: |
          echo "ðŸŽ‰ All checks completed!"
          echo "âœ… Code formatting and linting"
          echo "âœ… Flake metadata"
          echo "âœ… Custom packages"
          echo "âœ… NixOS configuration"
          echo "âœ… Home Manager configurations (nixos, wsl)"
          echo "âœ… Module syntax checks"